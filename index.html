<!--  index.html  • цельный рабочий файл  -->
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Cocktails Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
/* ---------- 1. Apple‑style дизайн ---------- */
:root{
  --blue:#007AFF;--blue-dark:#0060d1;--bg:#F2F2F7;--card:#FFFFFF;
  --border:#E5E5EA;--text:#1C1C1E;--radius:12px;--dur:.25s;
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Text','Helvetica Neue',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;background:var(--bg);color:var(--text);}
body{display:flex;align-items:center;justify-content:center;overflow-y:auto;}
body::before,body::after{content:'';flex-shrink:0;height:10vh;}
#app{width:100%;max-width:500px;padding:24px;}
h1{font-size:28px;font-weight:600;text-align:center;margin-bottom:24px;color:var(--blue);letter-spacing:-.3px;}
h3{margin:16px 0 8px;font-size:17px;font-weight:600;}
button{
  appearance:none;border:none;cursor:pointer;outline:none;
  background:var(--blue);color:#fff;font-size:17px;font-weight:500;
  padding:14px 18px;border-radius:var(--radius);width:100%;margin-top:12px;
  transition:background var(--dur),transform var(--dur);box-shadow:0 4px 10px rgba(0,0,0,.06);
}
button:hover{background:var(--blue-dark);}button:active{transform:scale(.97);}
.secondary-btn{background:var(--card);color:var(--blue);border:1px solid var(--blue);}
.secondary-btn:hover{background:#eaf1ff;}li button{width:auto;margin-left:6px;padding:6px 10px;font-size:15px;box-shadow:none;}
.md-input{position:relative;margin-top:12px;}
.md-input input{
  width:100%;font-size:17px;padding:22px 10px 6px;border:none;border-bottom:2px solid var(--border);
  background:transparent;outline:none;border-radius:var(--radius) var(--radius) 0 0;
  transition:border-color var(--dur);
}
.md-input input:focus{border-color:var(--blue);}
.md-input label{
  position:absolute;left:10px;top:22px;font-size:17px;color:#636366;pointer-events:none;
  transition:all var(--dur);
}
.md-input input:focus~label,
.md-input input:not(:placeholder-shown)~label{
  top:6px;font-size:13px;color:var(--blue);
}
.section{display:none;opacity:0;transition:opacity var(--dur);}
.show{display:block;opacity:1;}
ul{list-style:none;}li{
  background:var(--card);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 14px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;font-size:15px;
}
#selectedItems ul{margin-top:8px;}
.note{color:#34C759;font-weight:600;margin-top:8px;font-size:15px;}
.base-record{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;}
.base-record strong{display:block;margin-bottom:6px;font-size:15px;}
.suggestion{
  display:flex;align-items:center;background:var(--card);border:1px solid var(--border);
  border-radius:var(--radius);padding:10px;margin-top:6px;font-size:15px;
}
.suggestion input[type=number]{width:80px;margin:0 8px;font-size:15px;padding:4px;}
.suggestion:hover{background:#F9F9FB;}
.suggestion span{flex:1;line-height:1.3;}
@media(max-width:420px){button{font-size:16px;padding:12px 16px;}}
</style>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app">

<!-- Шаг 0 -->
<div id="startContainer" class="section show">
  <h1>Cocktails Calculator</h1>
  <button id="startBtn">Начать</button>
</div>

<!-- Шаг 1 -->
<div id="fioContainer" class="section">
  <h1>Cocktails Calculator</h1>
  <div class="md-input">
    <input type="text" id="fioInput" placeholder=" "/><label>ФИО клиента</label>
  </div>
  <button id="saveFioBtn">Сохранить</button>
  <button class="secondary-btn" id="backFromFioBtn">Назад</button>
</div>

<!-- Шаг 2 -->
<div id="baseContainer" class="section">
  <h1>Выберите базу</h1>
  <div id="baseButtons"></div>
  <button class="secondary-btn" id="backFromBaseBtn">Назад</button>
</div>

<!-- Шаг 3 -->
<div id="searchContainer" class="section">
  <h1 id="currentBaseIndicator"></h1>
  <div class="md-input">
    <input type="text" id="searchInput" placeholder=" "/><label>Поиск препарата</label>
  </div>
  <div id="suggestions"></div><div id="selectedItems"></div>
  <button id="newBaseBtn">Новая база</button>
  <button id="doneBtn">Готово</button>
  <button class="secondary-btn" id="backFromSearchBtn">Назад</button>
</div>

<!-- Шаг 4 -->
<div id="previousBasesContainer" class="section">
  <h3>Уже собранные базы</h3>
  <div id="previousBasesList"></div>
</div>
</div>

<script>
/* ------------------------------------------------------------------
   0. Telegram init
-------------------------------------------------------------------*/
const tg=Telegram.WebApp;tg.expand();
const userId=new URLSearchParams(location.search).get('user_id');

/* ------------------------------------------------------------------
   1.  Каталог DRUGS  (96 позиций)
-------------------------------------------------------------------*/
const DRUGS=[
 {name:'Глутатион',aliases:['Глатион'],dose:600,unit:'мг',presentation:'сух. вещество 1 фл',price:7000},
 {name:'Мексидол',dose:250,unit:'мг',presentation:'1 амп 5 мл',price:2000},
 {name:'Актовегин',dose:200,unit:'мг',presentation:'1 амп 5 мл',price:2500},
 {name:'Милдронат',dose:500,unit:'мг',presentation:'1 амп 5 мл',price:2000},
 {name:'Цераксон',dose:1000,unit:'мг',presentation:'1 амп 4 мл',price:2000},
 {name:'Димефосфон',dose:2,unit:'г',presentation:'2 амп 2 мл',price:4000},
 {name:'Лимфомиозот',dose:1.1,unit:'мл',presentation:'1 амп',price:2500},
 {name:'Цианокобаламин',aliases:['Витамин B12','B12','В12'],dose:0.5,unit:'мг',presentation:'1 амп 1 мл',price:2000},
 {name:'Лейковорин',aliases:['Витамин B9'],dose:50,unit:'мг',presentation:'1 фл 5 мл',price:5000},
 {name:'Магния сульфат',dose:750,unit:'мг',presentation:'1 амп 3 мл',price:2000},
 {name:'Кальция глюконат',dose:1000,unit:'мг',presentation:'1 амп 10 мл',price:2000},
 {name:'Циклоферон',dose:250,unit:'мг',presentation:'1 амп 2 мл',price:2000},
 {name:'Церебролизин',dose:10,unit:'мл',presentation:'1 амп',price:2500},
 {name:'Полиоксидоний',dose:6,unit:'мг',presentation:'1 фл',price:2500},
 {name:'Пикамилон',dose:200,unit:'мг',presentation:'1 амп 2 мл',price:2000},
 {name:'Пирацетам',dose:1000,unit:'мг',presentation:'1 амп 5 мл',price:1000},
 {name:'Рибоксин',aliases:['Инозин'],dose:200,unit:'мг',presentation:'1 амп 10 мл',price:2000},
 {name:'Натрия тиосульфат',dose:3000,unit:'мг',presentation:'1 амп 10 мл',price:2000},
 {name:'Панангин',dose:10,unit:'мл',presentation:'1 амп',price:2500},
 {name:'L‑лизина эсцинат',aliases:['Л‑лизин','Л‑лизина'],dose:5,unit:'мг',presentation:'1 амп 5 мл',price:4000},
 {name:'Глутоксим',dose:30,unit:'мг',presentation:'1 амп 1 мл',price:4000},
 {name:'Л‑карнитин',aliases:['Элькар','L‑Carnitin','Элькарнитин'],dose:500,unit:'мг',presentation:'1 амп 5 мл',price:3000},
 {name:'Коэнзим',dose:2.2,unit:'мл',presentation:'1 амп',price:4000},
 {name:'Гептрал',dose:400,unit:'мг',presentation:'сух. вещество 1 фл',price:4000},
 {name:'Цитофлавин',dose:10,unit:'мл',presentation:'1 амп',price:4000},
 {name:'Ремаксол',dose:400,unit:'мл',presentation:'готовый р‑р',price:4000},
 {name:'Реамберин',dose:250,unit:'мл',presentation:'готовый р‑р',price:4000},
 {name:'Альфа‑липоевая кислота',aliases:['Тиоктацид','Берлитион'],dose:600,unit:'мг',presentation:'1 амп 24 мл',price:4000},
 {name:'Езафосфина',dose:0.5,unit:'г',presentation:'1 фл',price:7000},
 {name:'Неотон',dose:1,unit:'г',presentation:'сух. вещество 1 фл',price:10000},
 {name:'Церетон',aliases:['Глиатилин'],dose:1000,unit:'мг',presentation:'1 амп 4 мл',price:2000},
 {name:'Кавинтон',dose:25,unit:'мг',presentation:'1 амп 5 мл',price:2000},
 {name:'Феринжект',dose:100,unit:'мг',presentation:'1 фл 2 мл',price:6000},
 {name:'Ликферр',dose:100,unit:'мг',presentation:'1 амп 5 мл',price:6000},
 {name:'Комплекс витаминов группы B',aliases:['Софарма'],dose:1,unit:'амп',presentation:'1 амп 2 мл',price:4000},
 {name:'Пиридоксин',aliases:['Витамин B6','B6','В6'],dose:100,unit:'мг',presentation:'2 амп 2 мл',price:2000},
 {name:'Тиамин',aliases:['Витамин B1','B1','В1'],dose:100,unit:'мг',presentation:'2 амп 2 мл',price:2000},
 {name:'Кокарбоксилаза',dose:100,unit:'мг',presentation:'2 амп 4 мл',price:2000},
 {name:'Флуимуцил',dose:600,unit:'мг',presentation:'2 фл сух. вещ.',price:3000},
 {name:'Фосфоглив',dose:500,unit:'мг',presentation:'1 фл сух. вещ.',price:5000},
 {name:'Альбумин',dose:100,unit:'мл',presentation:'готовый р‑р',price:11000},
 {name:'Аминовен инфант',dose:100,unit:'мл',presentation:'готовый р‑р',price:8000},
 {name:'Аминовен',dose:500,unit:'мл',presentation:'готовый р‑р',price:10000},
 {name:'Аддамель Н',dose:10,unit:'мл',presentation:'1 фл',price:3000},
 {name:'Виталипид Н',dose:10,unit:'мл',presentation:'1 амп',price:3000},
 {name:'Смофлипид',dose:100,unit:'мл',presentation:'готовый р‑р',price:10000},
 {name:'Стерофундин',dose:500,unit:'мл',presentation:'готовый р‑р',price:4000},
 {name:'Фриостерин',dose:500,unit:'мл',presentation:'готовый р‑р',price:4000},
 {name:'Эссенциале Н',dose:250,unit:'мг',presentation:'1 амп 5 мл',price:5000},
 {name:'Витамин C',aliases:['Аскорбиновая кислота','C','С'],dose:1000,unit:'мг',presentation:'5 амп 10 мл',price:2000},
 {name:'Витамин D',dose:300000,unit:'ЕД',presentation:'1 амп 1 мл',price:6000},
 {name:'Тамерит',dose:100,unit:'мг',presentation:'сух. вещество 1 амп',price:4500},
 {name:'Венофер',dose:100,unit:'мг',presentation:'1 фл',price:6000},
 {name:'Моликсан',dose:30,unit:'мг',presentation:'1 амп',price:2000},
 {name:'Тиоцетам',dose:5,unit:'мл',presentation:'1 амп',price:2000}
];

/* индекс по alias‑ключам */
const drugIndex={};
DRUGS.forEach(d=>{
  drugIndex[d.name.toLowerCase()]=d;
  (d.aliases||[]).forEach(a=>drugIndex[a.toLowerCase()]=d);
});

/* карта «canonical‑lowercase → {price,dose}» для расчётов */
const additionalPriceMap={};
DRUGS.forEach(d=>additionalPriceMap[d.name.toLowerCase()]={price:d.price,dose:d.dose});

/* ------------------------------------------------------------------
   2.  COCKTAILS  (28 капельниц из вашего ТЗ)
-------------------------------------------------------------------*/
const COCKTAILS=[
 {name:'Миланский коктейль день 1',price:18000,components:{'комплекс витаминов группы b':1,'цитофлавин':1,'езафосфина':1,'глутатион':1,'цианокобаламин':1,'витамин c':2}},
 {name:'Миланский коктейль день 2',price:18000,components:{'езафосфина':1,'глутатион':1,'цитофлавин':10,'лейковорин':1}},
 {name:'Спорт',price:12000,components:{'цитофлавин':1,'коэнзим':1,'актовегин':10,'витамин c':1000,'л‑карнитин':2}},
 {name:'Антистресс',price:10000,components:{'комплекс витаминов группы b':1,'магния сульфат':3,'пиридоксин':2,'кокарбоксилаза':2,'глутоксим':1,'витамин c':1000,'цианокобаламин':1}},
 {name:'Детокс+',price:12000,components:{'реамберин':250,'гептрал':1,'глутатион':1}},
 {name:'Antiage',price:14000,components:{'глутатион':1200,'витамин c':500}},
 {name:'Баланс железа',price:6500,components:{'феринжект':1}},
 {name:'Баланс железа +',price:8000,components:{'феринжект':1,'мексидол':5,'витамин c':500}},
 {name:'Красивая кожа',price:14000,components:{'эссенциале n':2,'глутатион':1,'витамин c':1000}},
 {name:'Смарт',price:10000,components:{'цитофлавин':1,'коэнзим':1,'цераксон':1,'кавинтон':1,'актовегин':5}},
 {name:'Красота+',price:12000,components:{'альфа‑липоевая кислота':1,'глутатион':1,'витамин c':500}},
 {name:'Протеиновый бустер',price:8000,components:{'аминовен':1,'аддамель n':0.5}},
 {name:'Усталость прочь',price:12000,components:{'альфа‑липоевая кислота':1,'комплекс витаминов группы b':1,'цитофлавин':1,'милдронат':10,'мексидол':5}},
 {name:'Орви help',price:10000,components:{'реамберин':1,'комплекс витаминов группы b':1,'витамин c':3000,'полиоксидоний':1,'кальция глюконат':1}},
 {name:'Здоровый сон',price:9000,components:{'гептрал':1,'пикамилон':1,'магния сульфат':4}},
 {name:'Жиросжигание',price:14000,components:{'альфа‑липоевая кислота':1,'цитофлавин':10,'коэнзим':1,'л‑карнитин':1,'витамин c':1000}},
 {name:'Здоровые сосуды',price:10000,components:{'l‑лизина эсцинат':1,'мексидол':10,'актовегин':10,'витамин c':500}},
 {name:'Здоровые волосы',price:15000,components:{'l‑лизина эсцинат':2,'аминовен':1,'аддамель n':0.5,'комплекс витаминов группы b':1,'лейковорин':50}},
 {name:'Антигистаминная',price:10000,components:{'l‑лизина эсцинат':2,'магния сульфат':3,'пиридоксин':2,'натрия тиосульфат':10,'кальция глюконат':1}},
 {name:'Противовирусная',price:12000,components:{'реамберин':1,'l‑лизина эсцинат':2,'циклоферон':1,'кальция глюконат':1,'витамин c':1000}},
 {name:'Пост ковид',price:10000,components:{'димефосфон':2,'реамберин':1,'комплекс витаминов группы b':1,'л‑карнитин':2,'цераксон':1}},
 {name:'Омега',price:12000,components:{'смофлипид':1,'виталипид n':2,'комплекс витаминов группы b':1}},
 {name:'Brain activity',price:10000,components:{'цитофлавин':1,'пирацетам':3,'мексидол':10,'актовегин':5}},
 {name:'Иммунитет',price:17000,components:{'реамберин':1,'комплекс витаминов группы b':1,'тамерит':2,'витамин c':3000,'цераксон':1,'кальция глюконат':10}},
 {name:'Коллагеностимуляция',price:24000,components:{'цитофлавин':1,'коэнзим':1,'эссенциале n':2,'аминовен':1,'аддамель n':0.5,'л‑карнитин':1,'витамин c':1000,'глутатион':600}},
 {name:'Jetlag',price:16000,components:{'цитофлавин':10,'коэнзим':1,'комплекс витаминов группы b':1,'магния сульфат':3,'пиридоксин':2,'кокарбоксилаза':2,'l‑лизина эсцинат':10,'л‑карнитин':1,'витамин c':1000,'цианокобаламин':1}},
 {name:'Противоотечная процедура',price:9000,components:{'димефосфон':2,'l‑лизина эсцинат':2,'лимфомиозот':1}}
];

/* ------------------------------------------------------------------
   3.  Базы
-------------------------------------------------------------------*/
const BASES=[
 {name:"Бустер физ.р‑р",price:0},{name:"Бустер стерил",price:0},{name:"Глюкоза 5% 200",price:0},
 {name:"Глюкоза 5% 100",price:0},{name:"физ р‑р 100",price:0},{name:"физ р‑р 200",price:0},{name:"физ р‑р 250",price:0},
 {name:"Стерофундин 500",price:4000},{name:"Фриостерин 500",price:4000},{name:"Реамбирин 250",price:4000},{name:"Ремаксол 400",price:4000},
 {name:"Аминовен 100 мл",price:8000},{name:"Аминовен 500 мл",price:10000},{name:"Смофлипид 100 мл",price:10000}
];
const BASE_TO_COMPONENT={
 "реамбирин 250":{ "реамберин":250 },"ремаксол 400":{ "ремаксол":400 },
 "стерофундин 500":{ "стерофундин":500 },"фриостерин 500":{ "фриостерин":500 },
 "смофлипид 100 мл":{ "смофлипид":100 },"аминовен 100 мл":{ "аминовен":100 },
 "аминовен 500 мл":{ "аминовен":500 }
};

/* ------------------------------------------------------------------
   4.  Глобальные переменные
-------------------------------------------------------------------*/
let allBases=[];let currentBaseName=null;let currentBasePrice=0;
let selectedItems={};let userFio="";let currentStep=0;

/* ------------------------------------------------------------------
   5.  Вспомогательные функции
-------------------------------------------------------------------*/
function canonical(name){
  const d=drugIndex[name.toLowerCase()];return d?d.name.toLowerCase():name.toLowerCase();
}
function showStep(i){
  ["startContainer","fioContainer","baseContainer","searchContainer","previousBasesContainer"]
    .forEach(id=>{
      const el=document.getElementById(id);
      if(!el) return;
      if(i===0&&id!=="startContainer"||
         i===1&&id!=="fioContainer"||
         i===2&&id!=="baseContainer"||
         i===3&&id!=="searchContainer"||
         i===4&&id!=="previousBasesContainer"){
           el.classList.remove('show');setTimeout(()=>el.style.display='none',250);
      }else{el.style.display='block';setTimeout(()=>el.classList.add('show'),0);}
    });
  currentStep=i;
}

/* ------------------------------------------------------------------
   6.  Поиск препаратов
-------------------------------------------------------------------*/
function handleSearchInput(){
  const q=document.getElementById('searchInput').value.trim().toLowerCase();
  const s=document.getElementById('suggestions');s.innerHTML='';
  if(!q) return;
  const seen=[];
  Object.keys(drugIndex).filter(k=>k.includes(q)).forEach(k=>{
    const d=drugIndex[k];if(seen.includes(d.name))return;seen.push(d.name);
    const row=document.createElement('div');row.className='suggestion';
    row.innerHTML=`<span><strong>${d.name}</strong> • ${d.presentation} • ${d.dose} ${d.unit}</span>`;
    const inp=document.createElement('input');inp.type='number';inp.step='0.01';inp.value=d.dose;
    const btn=document.createElement('button');btn.textContent='Добавить';
    btn.onclick=()=>{
      const val=parseFloat(inp.value)||d.dose;
      const key=d.name;selectedItems[key]=(selectedItems[key]||0)+val;
      document.getElementById('searchInput').value='';s.innerHTML='';renderSelectedItems();
    };
    row.appendChild(inp);row.appendChild(btn);s.appendChild(row);
  });
}

/* ------------------------------------------------------------------
   7.  Рендер выбранных препаратов
-------------------------------------------------------------------*/
function renderSelectedItems(){
  const c=document.getElementById('selectedItems');c.innerHTML='<h3>Выбранные препараты</h3>';
  if(!Object.keys(selectedItems).length){c.innerHTML+='<p>Пусто</p>';return;}
  const ul=document.createElement('ul');
  for(const n in selectedItems){
    const d=drugIndex[n.toLowerCase()];
    const li=document.createElement('li');
    li.textContent=`${n} — ${selectedItems[n]} ${d?d.unit:''} (${d?d.presentation:''})`;
    const e=document.createElement('button');e.textContent='Изм.';e.onclick=()=>{const nv=prompt('Новая доза',selectedItems[n]);if(nv!==null&&!isNaN(+nv)){selectedItems[n]=+nv;renderSelectedItems();}};
    const x=document.createElement('button');x.textContent='X';x.onclick=()=>{delete selectedItems[n];renderSelectedItems();};
    const wrap=document.createElement('span');wrap.append(e,x);li.appendChild(wrap);ul.appendChild(li);
  }c.appendChild(ul);
  const match=findCocktailPartialMatch(selectedItems,currentBaseName);
  if(match){
    const note=document.createElement('div');note.className='note';
    note.textContent=`Состав включает «${match.cocktail.name}»`;c.appendChild(note);
  }
}

/* ------------------------------------------------------------------
   8.  Поиск коктейля для одной базы
-------------------------------------------------------------------*/
function findCocktailPartialMatch(sel,baseName){
  if(!baseName) return null;
  const merged={};
  const baseComp=BASE_TO_COMPONENT[baseName.toLowerCase()]||{};
  for(const k in baseComp){const key=canonical(k);merged[key]=(merged[key]||0)+baseComp[k];}
  for(const k in sel){const key=canonical(k);merged[key]=(merged[key]||0)+sel[k];}
  let best=null,bestEx=Infinity;
  COCKTAILS.forEach(co=>{
    let enough=true,ex=0;
    for(const ck in co.components){
      const key=canonical(ck);if(!merged[key]||merged[key]<co.components[ck]){enough=false;break;}
      ex+=merged[key]-co.components[ck];
    }
    if(enough&&ex<bestEx){
      const leftover={};for(const ck in co.components){
        const key=canonical(ck);const rem=merged[key]-co.components[ck];if(rem>0) leftover[key]=rem;
      }
      best={cocktail:co,leftover};bestEx=ex;
    }
  });
  return best;
}

/* ------------------------------------------------------------------
   9.  Глобальный коктейль на все базы
-------------------------------------------------------------------*/
function findSingleGlobalCocktail(){
  const global={};
  allBases.forEach(b=>{
    const baseComp=BASE_TO_COMPONENT[b.baseName.toLowerCase()]||{};
    for(const k in baseComp){const key=canonical(k);global[key]=(global[key]||0)+baseComp[k];}
    for(const k in b.selectedItems){const key=canonical(k);global[key]=(global[key]||0)+b.selectedItems[k];}
  });
  let best=null,bestEx=Infinity;
  COCKTAILS.forEach(co=>{
    let enough=true,ex=0;
    for(const ck in co.components){
      const key=canonical(ck);if(!global[key]||global[key]<co.components[ck]){enough=false;break;}
      ex+=global[key]-co.components[ck];
    }
    if(enough&&ex<bestEx){
      const leftover={};for(const ck in co.components){
        const key=canonical(ck);const rem=global[key]-co.components[ck];if(rem>0) leftover[key]=rem;
      }
      best={cocktail:co,leftover};bestEx=ex;
    }
  });
  return best;
}
function baseIsInCocktail(co,baseName){
  const baseComp=BASE_TO_COMPONENT[baseName.toLowerCase()]||{};for(const k in baseComp){if(co.components[k]!==baseComp[k])return false;}return true;
}
function capitalize(str){return str?str[0].toUpperCase()+str.slice(1):'';}

/* ------------------------------------------------------------------
   10.  Сохранение / рендер баз
-------------------------------------------------------------------*/
function saveCurrentBase(){
  if(currentBaseName){
    allBases.push({baseName:currentBaseName,basePrice:currentBasePrice,selectedItems:{...selectedItems}});
  }
  currentBaseName=null;currentBasePrice=0;selectedItems={};renderSelectedItems();
}
function renderPreviousBases(){
  const c=document.getElementById('previousBasesList');c.innerHTML='';
  allBases.forEach((b,i)=>{
    const div=document.createElement('div');div.className='base-record';
    div.innerHTML=`<strong>База #${i+1}: ${b.baseName}</strong>`;
    if(!Object.keys(b.selectedItems).length){div.innerHTML+='<p>Без доп. препаратов</p>';}
    else{
      const ul=document.createElement('ul');
      for(const n in b.selectedItems){const li=document.createElement('li');li.textContent=`${n}: ${b.selectedItems[n]}`;ul.appendChild(li);}
      div.appendChild(ul);
    }
    c.appendChild(div);
  });
  document.getElementById('previousBasesContainer').style.display=allBases.length?'block':'none';
}

/* ------------------------------------------------------------------
   11.  Пропись и расчёт цены
-------------------------------------------------------------------*/
function buildPropis(){
  let lines=[];allBases.forEach((b,i)=>{
    lines.push(`База #${i+1}: ${b.baseName}`);
    const keys=Object.keys(b.selectedItems);
    if(!keys.length) lines.push('   (без доп.)');
    else keys.forEach(k=>lines.push(`   ${k} ${b.selectedItems[k]}`));
  });
  return lines.join('\n');
}
function calculateTotalAndExplanation(){
  const global=findSingleGlobalCocktail();let grand=0,details='';
  if(global){
    const {cocktail,leftover}=global;grand+=cocktail.price;
    let paid=0,paidLines=[];allBases.forEach(b=>{if(b.basePrice>0&&!baseIsInCocktail(cocktail,b.baseName)){paid+=b.basePrice;paidLines.push(`+ База "${b.baseName}" (${b.basePrice} руб.)`);}});
    grand+=paid;let leftCost=0,leftLines=[];
    for(const n in leftover){
      const info=additionalPriceMap[n];if(info){
        const factor=leftover[n]/info.dose||1;const cost=Math.round(info.price*factor);leftCost+=cost;
        leftLines.push(`+ Доп. ${capitalize(n)} ${leftover[n]} → ${cost} руб.`);
      }
    }
    grand+=leftCost;details=`Коктейль "${cocktail.name}" (${cocktail.price} руб.)`;
    if(paidLines.length) details+='\n'+paidLines.join('\n');
    if(leftLines.length) details+='\n'+leftLines.join('\n');
    details+=`\nСумма: ${grand} руб.`;
  }else{
    let lines=[];
    allBases.forEach((b,i)=>{
      let line=`База #${i+1}: ${b.baseName}`,sum=0;
      const local=findCocktailPartialMatch(b.selectedItems,b.baseName);
      if(local){
        const {cocktail,leftover}=local;let baseAdd=0;
        if(b.basePrice>0&&!baseIsInCocktail(cocktail,b.baseName)) baseAdd=b.basePrice;
        let leftCost=0,leftLines=[];
        for(const n in leftover){
          const info=additionalPriceMap[n];
          if(info){const factor=leftover[n]/info.dose||1;const cost=Math.round(info.price*factor);leftCost+=cost;leftLines.push(`+ ${capitalize(n)} ${leftover[n]} → ${cost}`);}
        }
        sum=baseAdd+cocktail.price+leftCost;
        line+=`\n   Коктейль "${cocktail.name}" (${cocktail.price})`;
        if(baseAdd) line+=`\n   + Платная база (${baseAdd})`;
        if(leftLines.length) line+='\n   '+leftLines.join('\n   ');
      }else{
        if(b.basePrice){sum+=b.basePrice;line+=`\n   Платная база (${b.basePrice})`;}
        for(const n in b.selectedItems){
          const info=additionalPriceMap[n.toLowerCase()];
          const cost=Math.round(info.price*(b.selectedItems[n]/info.dose||1));sum+=cost;
          line+=`\n   ${capitalize(n)} ${b.selectedItems[n]} → ${cost}`;
        }
      }
      line+=`\n   Итого: ${sum} руб.`;lines.push(line);grand+=sum;
    });
    details='Детали:\n'+lines.join('\n\n')+`\nСумма: ${grand} руб.`;
  }
  let discount=0;if(grand>30000)discount=.1;else if(grand>25000)discount=.07;else if(grand>20000)discount=.05;
  let final=grand;if(discount){final=Math.round(grand*(1-discount));details+=`\nСкидка ${discount*100}% → ${final}`;}
  const propis=buildPropis();
  return{total:final,explanation:`ФИО: ${userFio}\n${details}\n\nПропись:\n${propis}`};
}

/* ------------------------------------------------------------------
   12.  UI‑обработчики
-------------------------------------------------------------------*/
function onDone(){
  saveCurrentBase();renderPreviousBases();
  const {total,explanation}=calculateTotalAndExplanation();
  const payload={user_id:userId,user_fio:userFio,bases:allBases,total_price:total,explanation};
  Telegram.WebApp.sendData(JSON.stringify(payload));
}

/* ------------------------------------------------------------------
   13.  Инициализация
-------------------------------------------------------------------*/
window.onload=()=>{
  document.getElementById('startBtn').onclick=()=>showStep(1);
  document.getElementById('saveFioBtn').onclick=()=>{const fio=document.getElementById('fioInput').value.trim();if(!fio)return alert('Введите ФИО');userFio=fio;showStep(2);};
  document.getElementById('backFromFioBtn').onclick=()=>showStep(0);
  document.getElementById('backFromBaseBtn').onclick=()=>showStep(1);
  document.getElementById('backFromSearchBtn').onclick=()=>showStep(2);
  document.getElementById('searchInput').addEventListener('input',handleSearchInput);
  document.getElementById('doneBtn').onclick=onDone;
  document.getElementById('newBaseBtn').onclick=()=>{saveCurrentBase();renderPreviousBases();showStep(2);};
  const baseDiv=document.getElementById('baseButtons');
  BASES.forEach(b=>{const btn=document.createElement('button');btn.textContent=b.name;
    btn.onclick=()=>{saveCurrentBase();currentBaseName=b.name;currentBasePrice=b.price;selectedItems={};
      document.getElementById('currentBaseIndicator').textContent='Текущая база: '+b.name;showStep(3);renderSelectedItems();};
    baseDiv.appendChild(btn);
  });
};
</script>
</body>
</html>
