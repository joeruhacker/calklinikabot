<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Шрифт Google Roboto -->
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');

    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background: #FAFAFA;
      color: #212121;
      box-sizing: border-box;
    }
    * {
      box-sizing: inherit;
    }

    /* Центральный контейнер */
    #app {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Заголовок */
    h1 {
      text-align: center;
      color: #3F51B5; /* Indigo */
      margin-top: 0;
    }

    /* Все кнопки – единый стиль */
    button {
      background: #3F51B5; /* тот же цвет, что и заголовок */
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin: 4px;
    }
    button:hover {
      background: #303F9F; /* потемнее при hover */
    }

    /* Кнопка «Начать» */
    #startBtn {
      display: block;
      margin: 20px auto;
      font-size: 1.2rem;
      padding: 14px 24px;
    }

    /* Метки и инпуты */
    label {
      display: block;
      margin-top: 12px;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input[type="text"] {
      width: 100%;
      font-size: 1rem;
      padding: 8px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }

    /* Подсказки (автокомплит) */
    .suggestion {
      display: flex;
      align-items: center;
      background: #FFFFFF;
      padding: 8px;
      margin: 2px 0;
      border: 1px solid #CCC;
      border-radius: 4px;
      gap: 8px;
    }
    .suggestion:hover {
      background: #EEEEEE;
    }
    .suggestion span {
      flex: 1;
    }
    .suggestion input[type="number"] {
      width: 80px;
      margin-right: 8px;
    }

    /* Список выбранных препаратов */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      background: #FFFFFF;
      margin-bottom: 4px;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #E0E0E0;
      display: flex; 
      align-items: center;
      justify-content: space-between;
    }
    li button {
      margin: 0 4px;
      font-size: 0.9rem;
    }

    /* Кнопки «Новая база» и «Готово» */
    #newBaseBtn, #doneBtn {
      margin-top: 16px;
      display: none; /* будут показаны после выбора 1-й базы */
    }

    /* Контейнер выбранных препаратов */
    #selectedItems > h3 {
      margin-top: 20px;
      margin-bottom: 8px;
    }

    /* Примечание о коктейле */
    .note {
      color: green;
      margin-top: 8px;
      font-weight: bold;
    }

    /* Контейнер ранее собранных баз */
    #previousBasesContainer {
      margin-top: 24px;
      display: none; /* будет показан, если есть хотя бы 1 сохранённая база */
    }
    #previousBasesContainer h3 {
      margin: 0 0 12px;
      color: #3F51B5;
    }
    .base-record {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
      background: #fff;
    }
    .base-record strong {
      color: #333;
    }

    /* Отображение текущей базы */
    #currentBaseIndicator {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 12px 0;
      color: #3F51B5;
    }
  </style>

  <!-- Подключаем Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app">
  <h1>Cocktails Calculator</h1>

  <!-- (1) Кнопка "Начать" -->
  <div id="startContainer">
    <button id="startBtn">Начать</button>
  </div>

  <!-- (2) Блок ввода ФИО -->
  <div id="fioContainer" style="display:none;">
    <label>Фамилия Имя Отчество клиента:</label>
    <input type="text" id="fioInput" />
    <button id="saveFioBtn">Сохранить ФИО</button>
  </div>

  <!-- (3) Блок выбора базы -->
  <div id="baseContainer" style="display:none;">
    <label>Выберите базу (раствор):</label>
    <div id="baseButtons"></div>
  </div>

  <!-- (4) Блок поиска + список выбранных -->
  <div id="searchContainer" style="display:none;">
    <div id="currentBaseIndicator"></div>
    
    <label>Поиск препарата</label>
    <input type="text" id="searchInput" placeholder="Введите название..." />
    <div id="suggestions"></div>

    <div id="selectedItems"></div>
  </div>

  <!-- (5) Кнопки управления -->
  <button id="newBaseBtn">Новая база</button>
  <button id="doneBtn">Готово</button>

  <!-- (6) Список уже собранных баз -->
  <div id="previousBasesContainer">
    <h3>Уже собранные базы:</h3>
    <div id="previousBasesList"></div>
  </div>
</div>

<script>
/* -------------------------------------------------------
   1. Читаем user_id из URL
---------------------------------------------------------*/
let userId = null;
{
  const params = new URLSearchParams(window.location.search);
  userId = params.get('user_id');
  console.log("User ID:", userId);
}

/* -------------------------------------------------------
   2. Инициализация Telegram WebApp
---------------------------------------------------------*/
const tg = window.Telegram.WebApp;
tg.expand(); // Расширяем окно

/* -------------------------------------------------------
   3. Список коктейлей (name, price, components)
   - components: { препарат: доза, ... }
---------------------------------------------------------*/
const COCKTAILS = [
  {
    name: "Детокс+",
    price: 12000,
    components: {
      "реамберин": 250,
      "гептрал": 400,
      "глутатион": 600
    }
  },
  {
    name: "Миланский коктейль",
    price: 18000,
    components: {
      "глутатион": 1,
      "езафосфина": 1,
      "витамин в9": 1,
      "инозин": 1,
      "комплекс витаминов группы в": 1,
      "витамин с": 1
    }
  },
  {
    name: "Спорт",
    price: 12000,
    components: {
      "цитофлавин": 10,
      "коэнзим композитум": 1,
      "актовегин": 10,
      "витамин с": 1000,
      "l-карнитин": 10
    }
  },
  {
    name: "Антистресс",
    price: 10000,
    components: {
      "комплекс витаминов группы в": 1,
      "магния сульфат": 3,
      "пиридоксин": 2,
      "кокарбоксилаза": 2,
      "глутоксим": 1,
      "витамин с": 1000,
      "витамин в12": 1
    }
  },
  {
    name: "Antiage",
    price: 14000,
    components: {
      "глутатион": 1200,
      "витамин с": 500
    }
  },
  {
    name: "Баланс железа",
    price: 6500,
    components: {
      "феринжект": 1
    }
  },
  {
    name: "Баланс железа +",
    price: 8000,
    components: {
      "феринжект": 1,
      "мексидол": 5,
      "витамин с": 500
    }
  },
  {
    name: "Красивая кожа",
    price: 14000,
    components: {
      "эссенциале н": 2,
      "глутатион": 600,
      "витамин с": 1000
    }
  },
  {
    name: "Смарт",
    price: 10000,
    components: {
      "цитофлавин": 10,
      "коэнзим композитум": 1,
      "цераксон": 1000,
      "кавинтон": 4,
      "актовегин": 5
    }
  },
  {
    name: "Красота+",
    price: 12000,
    components: {
      "глутатион": 600,
      "витамин с": 500,
      "тиоктацид": 600
    }
  },
  {
    name: "Протеиновый бустер",
    price: 8000,
    components: {
      "аминовен": 100,
      "аддамель н": 0.5
    }
  },
  {
    name: "Усталость прочь",
    price: 12000,
    components: {
      "тиоктацид": 600,
      "цитофлавин": 10,
      "комплекс витаминов группы в": 1,
      "милдронат": 10,
      "мексидол": 5
    }
  },
  {
    name: "Орви help",
    price: 10000,
    components: {
      "реамберин": 250,
      "комплекс витаминов группы в": 1,
      "витамин с": 3000,
      "полиоксидоний": 1,
      "кальция глюконат": 10
    }
  },
  {
    name: "Здоровый сон",
    price: 9000,
    components: {
      "гептрал": 400,
      "пикамилон": 1,
      "магния сульфат": 4
    }
  },
  {
    name: "Жиросжигание",
    price: 14000,
    components: {
      "тиоктацид": 600,
      "цитофлавин": 10,
      "коэнзим композитум": 1,
      "l-карнитин": 10,
      "витамин с": 1000
    }
  },
  {
    name: "Здоровые сосуды",
    price: 10000,
    components: {
      "l-лизина эсцинат": 5,
      "мексидол": 10,
      "актовегин": 10,
      "витамин с": 500
    }
  },
  {
    name: "Здоровые волосы",
    price: 15000,
    components: {
      "l-лизина эсцинат": 10,
      "аминовен": 100,
      "аддамель н": 0.5,
      "комплекс витаминов группы в": 1,
      "лейковорин": 50
    }
  },
  {
    name: "Антигистаминная",
    price: 10000,
    components: {
      "l-лизина эсцинат": 10,
      "магния сульфат": 3,
      "пиридоксин": 2,
      "натрия тиосульфат": 10,
      "кальция глюконат": 10
    }
  },
  {
    name: "Противовирусная",
    price: 12000,
    components: {
      "реамберин": 250,
      "l-лизина эсцинат": 10,
      "циклоферон": 1,
      "кальция глюконат": 10,
      "витамин с": 1000
    }
  },
  {
    name: "Пост ковид",
    price: 10000,
    components: {
      "димефосфон": 2,
      "реамберин": 250,
      "комплекс витаминов группы в": 1,
      "l-карнитин": 10,
      "цераксон": 1000
    }
  },
  {
    name: "Омега",
    price: 12000,
    components: {
      "смофлипид": 100,
      "виталипид н": 2,
      "комплекс витаминов группы в": 1
    }
  },
  {
    name: "Brain activity",
    price: 10000,
    components: {
      "цитофлавин": 10,
      "пирацетам": 3000,
      "мексидол": 10,
      "актовегин": 5
    }
  },
  {
    name: "Иммунитет",
    price: 17000,
    components: {
      "реамберин": 250,
      "комплекс витаминов группы в": 1,
      "тамерит": 2,
      "витамин с": 3000,
      "цераксон": 1000,
      "кальция глюконат": 10
    }
  },
  {
    name: "Коллагеностимуляция",
    price: 24000,
    components: {
      "цитофлавин": 10,
      "коэнзим композитум": 1,
      "эссенциале н": 2,
      "аминовен": 100,
      "аддамель н": 0.5,
      "l-карнитин": 10,
      "витамин с": 1000,
      "глутатион": 600
    }
  },
  {
    name: "Jetlag",
    price: 16000,
    components: {
      "цитофлавин": 10,
      "коэнзим композитум": 1,
      "комплекс витаминов группы в": 1,
      "магния сульфат": 3,
      "пиридоксин": 2,
      "кокарбоксилаза": 2,
      "l-лизин": 10,
      "l-карнитин": 10,
      "витамин с": 1000,
      "витамин в12": 1
    }
  },
  {
    name: "Противоотечная процедура",
    price: 9000,
    components: {
      "димефосфон": 2,
      "l-лизин": 10,
      "лимфомиозот": 1
    }
  },
  {
    name: "Стоп Псориаз",
    price: 16500,
    components: {
      "реамберин": 250,
      "эссенциале н": 2,
      "l-лизин": 10,
      "витамин с": 1000,
      "кальция глюконат": 10,
      "фосфоглив": 1
    }
  },
  {
    name: "Восстановление печени",
    price: 21000,
    components: {
      "ремаксол": 400,
      "комплекс витаминов группы в": 1,
      "гептрал": 800,
      "эссенциале н": 1,
      "глутатион": 600
    }
  },
  {
    name: "После вечеринки",
    price: 13500,
    components: {
      "ремаксол": 500, 
      "панангин": 10,
      "комплекс витаминов группы в": 1,
      "натрия тиосульфат": 10,
      "витамин с": 1000,
      "l-карнитин": 10
    }
  }
];

/* -------------------------------------------------------
   4. Список доп. препаратов (название -> {price, dose})
---------------------------------------------------------*/
const ADDITIONAL_PRICES = {
  "реамберин":       { "price": 4000, "dose": 250 },
  "гептрал":         { "price": 4000, "dose": 400 },
  "глутатион":       { "price": 7000, "dose": 600 },

  "мексидол":        { "price": 2000, "dose": 5 },
  "актовегин":       { "price": 2500, "dose": 5 },
  "милдронат":       { "price": 2000, "dose": 5 },
  "цераксон":        { "price": 2000, "dose": 1000 },
  "димефосфон":      { "price": 4000, "dose": 2 },
  "лимфомиозот":     { "price": 2500, "dose": 1 },
  "витамин в12":     { "price": 2000, "dose": 1 },
  "лейковорин":      { "price": 5000, "dose": 50 },
  "магния сульфат":  { "price": 2000, "dose": 3 },
  "кальция глюконат":{ "price": 2000, "dose": 10 },
  "циклоферон":      { "price": 2000, "dose": 1 },
  "церебролизин":    { "price": 2500, "dose": 10 },
  "полиоксидоний":   { "price": 2500, "dose": 1 },
  "пикамилон":       { "price": 2000, "dose": 1 },
  "пирацетам":       { "price": 1000, "dose": 1000 },
  "рибоксин":        { "price": 2000, "dose": 10 },
  "натрия тиосульфат": { "price": 2000, "dose": 10 },
  "панангин":        { "price": 2500, "dose": 10 },
  "l-лизина эсцинат":{ "price": 4000, "dose": 5 },
  "l-лизин":         { "price": 4000, "dose": 10 },
  "l-карнитин":      { "price": 1500, "dose": 5 },
  "коэнзим композитум": { "price": 4000, "dose": 1 },
  "цитофлавин":      { "price": 4000, "dose": 10 },
  "ремаксол":        { "price": 4000, "dose": 400 },
  "берлитион":       { "price": 4000, "dose": 600 },
  "тиоктацид":       { "price": 4000, "dose": 600 },
  "езафосфина":      { "price": 7000, "dose": 1 },
  "неотон":          { "price": 10000, "dose": 1 },
  "церетон":         { "price": 2000, "dose": 1000 },
  "кавинтон":        { "price": 2000, "dose": 4 },
  "феринжект":       { "price": 6000, "dose": 1 },
  "ликферр":         { "price": 6000, "dose": 1 },
  "комплекс витаминов группы в": { "price": 4000, "dose": 1 },
  "пиридоксин":      { "price": 1000, "dose": 1 },
  "тиамин":          { "price": 2000, "dose": 2 },
  "кокарбоксилаза":  { "price": 1000, "dose": 1 },
  "глутоксим":       { "price": 3000, "dose": 1 },
  "флуимуцил":       { "price": 1500, "dose": 1 },
  "фосфоглив":       { "price": 5000, "dose": 1 },
  "альбумин":        { "price": 11000, "dose": 100 },
  "аминовен инфант": { "price": 8000, "dose": 100 },
  "аминовен":        { "price": 10000, "dose": 500 },
  "аддамель н":      { "price": 3000, "dose": 1 },
  "виталипид н":     { "price": 3000, "dose": 1 },
  "смофлипид":       { "price": 10000, "dose": 100 },
  "стерофундин":     { "price": 4000, "dose": 500 },
  "фриостерин":      { "price": 4000, "dose": 500 },
  "эссенциале н":    { "price": 5000, "dose": 1 },
  "витамин с":       { "price": 2000, "dose": 1000 },
  "витамин д":       { "price": 6000, "dose": 1 },
  "тамерит":         { "price": 4500, "dose": 1 }
};

/* -------------------------------------------------------
   5. Базы (некоторые платные)
   - name, price
---------------------------------------------------------*/
const BASES = [
  { name: "Бустер физ.р-р", price: 0 },
  { name: "Бустер стерил", price: 0 },
  { name: "Глюкоза 5% 200.0", price: 0 },
  { name: "Глюкоза 5% 100 (200-100)", price: 0 },
  { name: "физ р-р 200", price: 0 },
  { name: "физ р-р 250", price: 0 },
  // Платные:
  { name: "Стерофундин 500", price: 4000 },
  { name: "Фриостерин 500", price: 4000 },
  { name: "физ р-р 200", price: 0 }, // повтор
  { name: "Реамбирин 250", price: 4000 },
  { name: "Ремаксол 400", price: 4000 }
];

/* 
  Мапа (название базы -> какие компоненты добавляет):
  Например, если выбрана "Реамбирин 250" => добавляем 
  {реамберин: 250} в общий список, чтобы найти коктейль.
*/
const BASE_TO_COMPONENT = {
  "реамбирин 250":  { "реамберин": 250 },
  "ремаксол 400":   { "ремаксол": 400 },
  "стерофундин 500": { "стерофундин": 500 },
  "фриостерин 500": { "фриостерин": 500 }
};

/* -------------------------------------------------------
   6. Глобальные переменные
---------------------------------------------------------*/
let allBases = [];           // массив объектов { baseName, basePrice, selectedItems }
let currentBaseName = null;  // текущая база (строка)
let currentBasePrice = 0;    // её стоимость
let selectedItems = {};      // препараты для текущей базы (объект {имя: число})
let userFio = "";            // ФИО клиента

/* -------------------------------------------------------
   7. Подготовка автокомплита (только препараты)
---------------------------------------------------------*/
const additionalItemsByName = {};
Object.keys(ADDITIONAL_PRICES).forEach(k => {
  additionalItemsByName[k.toLowerCase()] = ADDITIONAL_PRICES[k];
});
const allNames = Object.keys(additionalItemsByName); // список названий (lowercase)

/* -------------------------------------------------------
   8. Поиск препаратов (input)
   Формируем список подсказок, в каждой подсказке будет input с дозировкой
---------------------------------------------------------*/
function handleSearchInput() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  const suggestionsDiv = document.getElementById('suggestions');
  suggestionsDiv.innerHTML = '';

  if (!query) return; // пусто — не показываем
  const matched = allNames.filter(n => n.includes(query));

  matched.forEach(m => {
    const info = additionalItemsByName[m];
    const div = document.createElement('div');
    div.className = 'suggestion';

    const spanName = document.createElement('span');
    spanName.textContent = m; // отображаем название

    const doseInput = document.createElement('input');
    doseInput.type = 'number';
    doseInput.step = '0.01';
    doseInput.value = info.dose; // стандартная доза

    const addBtn = document.createElement('button');
    addBtn.textContent = 'Добавить';
    addBtn.onclick = () => {
      const d = parseFloat(doseInput.value) || info.dose;
      selectedItems[m] = (selectedItems[m] || 0) + d;
      document.getElementById('searchInput').value = '';
      suggestionsDiv.innerHTML = '';
      renderSelectedItems();
    };

    div.appendChild(spanName);
    div.appendChild(doseInput);
    div.appendChild(addBtn);
    suggestionsDiv.appendChild(div);
  });
}

/* -------------------------------------------------------
   9. Перерисовка списка выбранных препаратов
---------------------------------------------------------*/
function renderSelectedItems() {
  const container = document.getElementById('selectedItems');
  container.innerHTML = '<h3>Выбранные препараты:</h3>';

  if (Object.keys(selectedItems).length === 0) {
    container.innerHTML += '<p>Пусто</p>';
    return;
  }

  const ul = document.createElement('ul');
  for (const name in selectedItems) {
    const li = document.createElement('li');
    li.textContent = `${name}: ${selectedItems[name]}`;

    // Изменить дозировку (button)
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Изм.';
    editBtn.onclick = () => {
      const oldVal = selectedItems[name];
      const newValStr = prompt("Введите новую дозировку:", oldVal);
      if (newValStr !== null) {
        const newVal = parseFloat(newValStr);
        if (!isNaN(newVal)) {
          selectedItems[name] = newVal;
          renderSelectedItems();
        }
      }
    };

    // Удалить препарат (button)
    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.onclick = () => {
      delete selectedItems[name];
      renderSelectedItems();
    };

    const btnsWrapper = document.createElement('span');
    btnsWrapper.appendChild(editBtn);
    btnsWrapper.appendChild(removeBtn);
    li.appendChild(btnsWrapper);

    ul.appendChild(li);
  }
  container.appendChild(ul);

  // Проверяем, не содержит ли данный набор ( + база ) готовый коктейль
  const singleBaseResult = findCocktailPartialMatch(selectedItems, currentBaseName);
  if (singleBaseResult) {
    const { cocktail } = singleBaseResult;
    const note = document.createElement('div');
    note.className = 'note';
    note.textContent =
      `Состав этой базы включает коктейль "${cocktail.name}" (цена: ${cocktail.price} руб.) 
(возможно, есть доп. препараты сверх рецепта).`;
    container.appendChild(note);
  }
}

/* -------------------------------------------------------
   10. Новая функция: findCocktailPartialMatch
   Разрешаем «дозы >=» вместо точного равенства.
   Возвращает { cocktail, leftover } или null.
---------------------------------------------------------*/
function findCocktailPartialMatch(selected, baseName) {
  const normalizedBaseName = (baseName || '').toLowerCase();
  const baseObj = BASE_TO_COMPONENT[normalizedBaseName] || {};

  // Сольём компоненты базы + выбранные
  const merged = {};
  for (const k in baseObj) {
    merged[k] = (merged[k] || 0) + baseObj[k];
  }
  for (const k in selected) {
    merged[k] = (merged[k] || 0) + selected[k];
  }

  // Перебираем все коктейли
  for (const c of COCKTAILS) {
    let enough = true;
    for (const ck in c.components) {
      if (!merged[ck] || merged[ck] < c.components[ck]) {
        enough = false;
        break;
      }
    }
    if (!enough) continue;

    // Если «хватает» по всем компонентам,
    // сформируем leftover (избыточные дозировки)
    const leftover = { ...merged };
    for (const ck in c.components) {
      leftover[ck] -= c.components[ck];
      if (leftover[ck] <= 0) {
        delete leftover[ck]; 
      }
    }

    return { cocktail: c, leftover };
  }

  // Если ничего не подошло
  return null;
}

/* -------------------------------------------------------
   11. Сохранить текущую базу (если есть) в allBases
---------------------------------------------------------*/
function saveCurrentBase() {
  if (!currentBaseName) return;
  const baseRecord = {
    baseName: currentBaseName,
    basePrice: currentBasePrice,
    selectedItems: { ...selectedItems } // копия
  };
  allBases.push(baseRecord);

  // сброс
  currentBaseName = null;
  currentBasePrice = 0;
  selectedItems = {};
  renderSelectedItems();
}

/* -------------------------------------------------------
   12. Рендер ранее собранных баз (внизу)
---------------------------------------------------------*/
function renderPreviousBases() {
  const container = document.getElementById('previousBasesList');
  container.innerHTML = '';

  allBases.forEach((b, idx) => {
    const baseDiv = document.createElement('div');
    baseDiv.className = 'base-record';
    baseDiv.innerHTML = `<strong>База #${idx + 1}: ${b.baseName}</strong>`;

    const sItems = b.selectedItems;
    if (Object.keys(sItems).length === 0) {
      baseDiv.innerHTML += `<p>Без препаратов</p>`;
    } else {
      const ul = document.createElement('ul');
      for (const name in sItems) {
        const li = document.createElement('li');
        li.textContent = `${name}: ${sItems[name]}`;
        ul.appendChild(li);
      }
      baseDiv.appendChild(ul);
    }
    container.appendChild(baseDiv);
  });

  document.getElementById('previousBasesContainer').style.display = 
    allBases.length > 0 ? 'block' : 'none';
}

/* -------------------------------------------------------
   13. Проверка, входит ли платная база в коктейль 
       (точное соответствие доз в рецепте).
---------------------------------------------------------*/
function baseIsInCocktail(cocktail, baseName) {
  const baseKeyVals = BASE_TO_COMPONENT[baseName.toLowerCase()];
  if (!baseKeyVals) return false;
  for (const k in baseKeyVals) {
    if (cocktail.components[k] !== baseKeyVals[k]) {
      return false;
    }
  }
  return true;
}

/* 
   14. Глобальный поиск одного-единственного коктейля 
       по всем базам. Разрешаем «доз >=».
*/
function findSingleGlobalCocktail() {
  // Сольём все препараты (и компоненты платных баз) в один объект globalItems
  const globalItems = {};

  for (const b of allBases) {
    const baseNormalized = b.baseName.toLowerCase();
    const baseComp = BASE_TO_COMPONENT[baseNormalized] || {};
    for (const k in baseComp) {
      globalItems[k] = (globalItems[k] || 0) + baseComp[k];
    }
    for (const k in b.selectedItems) {
      globalItems[k] = (globalItems[k] || 0) + b.selectedItems[k];
    }
  }

  // Ищем коктейль, на который «хватает» доз
  for (const c of COCKTAILS) {
    let enough = true;
    for (const ck in c.components) {
      if (!globalItems[ck] || globalItems[ck] < c.components[ck]) {
        enough = false;
        break;
      }
    }
    if (!enough) continue;

    // Формируем leftover
    const leftover = { ...globalItems };
    for (const ck in c.components) {
      leftover[ck] -= c.components[ck];
      if (leftover[ck] <= 0) {
        delete leftover[ck];
      }
    }
    return { cocktail: c, leftover };
  }

  return null;
}

/* -------------------------------------------------------
   15. Расчёт итоговой цены + объяснение
---------------------------------------------------------*/
function calculateTotalAndExplanation() {
  // 1) Сначала проверяем, не формирует ли всё вместе 1 глобальный коктейль
  const globalCocktailCheck = findSingleGlobalCocktail();
  if (globalCocktailCheck) {
    // Если нашли единый коктейль:
    const c = globalCocktailCheck.cocktail;
    const leftover = globalCocktailCheck.leftover;
    let total = c.price;
    let explanation = `Обнаружен единый коктейль "${c.name}" (цена: ${c.price} руб.)\n`;

    // Добавим стоимость leftover + платных баз, которые не входят в коктейль
    // Поскольку у нас всё разбито по базам, придётся пройтись отдельно:
    let leftoverCost = 0;
    let baseCost = 0;
    allBases.forEach((b, index) => {
      const baseNormalized = b.baseName.toLowerCase();
      const isBaseInCocktail = baseIsInCocktail(c, baseNormalized);
      if (b.basePrice > 0 && !isBaseInCocktail) {
        baseCost += b.basePrice;
      }
    });

    // leftover построчно
    for (const name in leftover) {
      const userDose = leftover[name];
      const info = additionalItemsByName[name.toLowerCase()];
      if (info) {
        let factor = userDose / info.dose;
        if (factor < 0.0001) factor = 1;
        leftoverCost += Math.round(info.price * factor);
      }
    }

    total += baseCost + leftoverCost;
    if (baseCost > 0) {
      explanation += `+ Платные базы вне коктейля: ${baseCost} руб.\n`;
    }
    if (leftoverCost > 0) {
      explanation += `+ Доп. доза сверх коктейля: ${leftoverCost} руб.\n`;
    }

    explanation += `Итого: ${total} руб.`;
    return { total, explanation };
  }

  // 2) Иначе — подробный расчёт по каждой базе
  let grandTotal = 0;
  let explanation = "Подробный расчёт по базам:\n";

  allBases.forEach((base, index) => {
    const baseIndex = index + 1;
    let baseSum = 0;
    let baseExplanation = `База #${baseIndex}: ${base.baseName}\n`;

    // Проверка «местного» коктейля
    const localCheck = findCocktailPartialMatch(base.selectedItems, base.baseName);
    if (localCheck) {
      const c = localCheck.cocktail;
      const leftover = localCheck.leftover;

      // Платная база, если она не включена в этот коктейль
      if (base.basePrice > 0 && !baseIsInCocktail(c, base.baseName)) {
        baseSum += base.basePrice;
        baseExplanation += `   Платная база: ${base.basePrice} руб.\n`;
      }

      // Сама цена коктейля
      baseSum += c.price;
      baseExplanation += `   Коктейль "${c.name}": ${c.price} руб.\n`;

      // leftover (то, что сверх рецептуры)
      for (const name in leftover) {
        const userDose = leftover[name];
        const info = additionalItemsByName[name.toLowerCase()];
        if (info) {
          let factor = userDose / info.dose;
          if (factor < 0.0001) factor = 1;
          const cost = Math.round(info.price * factor);
          baseSum += cost;
          baseExplanation += `       + "${name}" (доп. доза ${userDose}) => ${cost} руб.\n`;
        } else {
          baseExplanation += `       + "${name}" (неизвестно) => 0 руб.\n`;
        }
      }

    } else {
      // Никакого коктейля: всё тарифицируем построчно + учитываем платность базы
      if (base.basePrice > 0) {
        baseSum += base.basePrice;
        baseExplanation += `   Платная база: ${base.basePrice} руб.\n`;
      }
      for (const name in base.selectedItems) {
        const userDose = base.selectedItems[name];
        const info = additionalItemsByName[name.toLowerCase()];
        if (info) {
          let factor = userDose / info.dose;
          if (factor < 0.0001) factor = 1;
          const cost = Math.round(info.price * factor);
          baseSum += cost;
          baseExplanation += `   "${name}" доза ${userDose} => ${cost} руб.\n`;
        } else {
          baseExplanation += `   "${name}" не найдено в ADDITIONAL_PRICES => 0 руб.\n`;
        }
      }
    }

    baseExplanation += `   Итого по базе #${baseIndex}: ${baseSum} руб.\n\n`;
    grandTotal += baseSum;
    explanation += baseExplanation;
  });

  explanation += `ОБЩАЯ СУММА: ${grandTotal} руб.\n`;
  return { total: grandTotal, explanation };
}

/* -------------------------------------------------------
   16. "Готово": сохраняем текущую базу => считаем => отправляем
---------------------------------------------------------*/
function onDone() {
  saveCurrentBase();
  renderPreviousBases();

  const { total, explanation } = calculateTotalAndExplanation();
  const dataToSend = {
    user_id: userId,
    user_fio: userFio,
    bases: allBases,
    total_price: total,
    explanation: explanation
  };

  // Отправляем в Telegram
  Telegram.WebApp.sendData(JSON.stringify(dataToSend));
  // tg.close(); // при необходимости закрыть мини-апп
}

/* -------------------------------------------------------
   17. Обработчики UI
---------------------------------------------------------*/
function onStart() {
  document.getElementById('startContainer').style.display = 'none';
  document.getElementById('fioContainer').style.display = 'block';
}

function onSaveFio() {
  const fio = document.getElementById('fioInput').value.trim();
  if (!fio) {
    alert("Введите ФИО клиента!");
    return;
  }
  userFio = fio;

  // Переходим к выбору базы
  document.getElementById('fioContainer').style.display = 'none';
  document.getElementById('baseContainer').style.display = 'block';
}

function onSelectBase(baseName, basePrice) {
  // Сохраняем, если уже какая-то база была выбрана
  saveCurrentBase();

  // Активируем новую базу
  currentBaseName = baseName;
  currentBasePrice = basePrice;
  selectedItems = {};

  // Прячем кнопки базы, показываем поиск
  document.getElementById('baseContainer').style.display = 'none';
  document.getElementById('searchContainer').style.display = 'block';

  // Делаем видимыми кнопки "Новая база" и "Готово"
  document.getElementById('newBaseBtn').style.display = 'inline-block';
  document.getElementById('doneBtn').style.display = 'inline-block';

  // Отображаем название текущей базы
  document.getElementById('currentBaseIndicator').textContent = "Текущая база: " + baseName;

  renderSelectedItems();
}

function onNewBase() {
  // Сохраняем текущую базу
  saveCurrentBase();
  // Отрисовываем список предыдущих
  renderPreviousBases();

  // Показываем выбор базы, прячем поиск
  document.getElementById('searchContainer').style.display = 'none';
  document.getElementById('baseContainer').style.display = 'block';
}

/* -------------------------------------------------------
   18. Инициализация при загрузке
---------------------------------------------------------*/
window.onload = () => {
  // Кнопки
  document.getElementById('startBtn').addEventListener('click', onStart);
  document.getElementById('saveFioBtn').addEventListener('click', onSaveFio);
  document.getElementById('searchInput').addEventListener('input', handleSearchInput);
  document.getElementById('doneBtn').addEventListener('click', onDone);
  document.getElementById('newBaseBtn').addEventListener('click', onNewBase);

  // Генерируем кнопки для всех баз
  const baseButtonsDiv = document.getElementById('baseButtons');
  BASES.forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = b.name;
    btn.onclick = () => onSelectBase(b.name, b.price);
    baseButtonsDiv.appendChild(btn);
  });
};
</script>
</body>
</html>
