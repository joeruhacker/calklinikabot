<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Telegram MiniApp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Шрифт Google San Francisco (эмуляция) -->
  <style>
    @import url('https://fonts.googleapis.com/css?family=Roboto&display=swap');

    :root {
      --primary-color: #0A84FF; /* Яблочный синий */
      --primary-dark: #0050A3;
      --background-color: #FAFAFA;
      --text-color: #1C1C1E;
      --border-color: #E5E5EA;
    }

    * {
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--background-color);
      color: var(--text-color);
    }

    /* Контейнер */
    #app {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Заголовок */
    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-top: 0;
    }

    /* Кнопки */
    button {
      background: var(--primary-color);
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      margin: 4px;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }
    button:hover {
      background: var(--primary-dark);
    }
    button:active {
      transform: scale(0.97);
    }

    /* Вспомогательные кнопки (кнопка назад и т.п.) */
    .secondary-btn {
      background: #F2F2F7;
      color: var(--text-color);
    }
    .secondary-btn:hover {
      background: #E5E5EA;
    }

    /* Инпуты (имитация Material Design) */
    .md-input {
      position: relative;
      margin: 20px 0;
      width: 100%;
    }
    .md-input input {
      width: 100%;
      font-size: 1rem;
      padding: 12px 8px 8px;
      border: none;
      border-bottom: 2px solid #CDD1D9;
      background: transparent;
      outline: none;
      transition: border-color 0.3s ease;
    }
    .md-input input:focus {
      border-color: var(--primary-color);
    }
    .md-input label {
      position: absolute;
      top: 12px;
      left: 8px;
      font-size: 1rem;
      color: #8E8E93;
      pointer-events: none;
      transition: 0.3s ease all;
    }
    .md-input input:focus ~ label,
    .md-input input:not(:placeholder-shown) ~ label {
      top: -8px;
      font-size: 0.8rem;
      color: var(--primary-color);
    }

    /* Кнопка очистки поля поиска */
    .clear-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      display: none;
      color: #8E8E93;
    }

    /* Скрытые блоки */
    .hidden {
      display: none;
    }

    /* Секции */
    .section {
      margin-top: 20px;
    }

    /* Смещение экранов чуть ниже центра */
    #startContainer,
    #fioContainer,
    #searchContainer {
      padding-top: 20vh;
    }

    /* Подсказки (автокомплит) */
    .suggestion {
      display: flex;
      align-items: center;
      background: #FFFFFF;
      padding: 8px;
      margin: 4px 0;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      gap: 8px;
      transition: background-color 0.2s ease;
    }
    .suggestion:hover {
      background: #F2F2F7;
    }
    .suggestion span.name {
      flex: 1;
      color: var(--text-color);
    }
    .suggestion input[type="number"] {
      width: 80px;
      margin-right: 4px;
      border: 1px solid #CDD1D9;
      border-radius: 6px;
      padding: 4px;
      transition: border-color 0.3s ease;
    }
    .suggestion input[type="number"]:focus {
      border-color: var(--primary-color);
    }
    .suggestion span.unit {
      margin-right: 8px;
      color: #8E8E93;
    }

    /* Список выбранных препаратов */
    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    li {
      background: #FFFFFF;
      margin-bottom: 4px;
      padding: 8px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.2s ease;
    }
    li:hover {
      background: #F2F2F7;
    }
    li button {
      margin: 0 4px;
      font-size: 0.9rem;
      border-radius: 8px;
      transition: background-color 0.3s ease, transform 0.1s ease;
    }

    /* Примечание о коктейле */
    .note {
      color: green;
      margin-top: 8px;
      font-weight: bold;
    }

    /* Ранее собранные базы */
    .base-record {
      border: 1px solid #CDD1D9;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: #FFFFFF;
    }
    .base-record strong {
      color: var(--text-color);
    }

    /* Отображение текущей базы */
    #currentBaseIndicator {
      font-size: 1.1rem;
      font-weight: bold;
      margin: 12px 0;
      color: var(--primary-color);
    }

    /* Адаптивность */
    @media (max-width: 600px) {
      button {
        width: 100%;
        margin-bottom: 8px;
      }
    }

  </style>

  <!-- Подключаем Telegram WebApp JS -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div id="app">
  <h1>Cocktails Calculator</h1>

  <!-- Шаг 0. "Начать" -->
  <div id="startContainer">
    <button id="startBtn">Начать</button>
  </div>

  <!-- Шаг 1. Ввод ФИО -->
  <div id="fioContainer" class="hidden">
    <div class="md-input">
      <input type="text" id="fioInput" placeholder=" " />
      <label>Фамилия Имя Отчество клиента</label>
    </div>
    <button id="saveFioBtn">Сохранить ФИО</button>
    <button class="secondary-btn" id="backFromFioBtn">Назад</button>
  </div>

  <!-- Шаг 2. Выбор базы -->
  <div id="baseContainer" class="hidden section">
    <p>Выберите базу (раствор):</p>
    <div id="baseButtons"></div>
    <button class="secondary-btn" id="backFromBaseBtn">Назад</button>
  </div>

  <!-- Шаг 3. Добавление препаратов -->
  <div id="searchContainer" class="hidden section">
    <div id="currentBaseIndicator"></div>
    <div class="md-input">
      <input type="text" id="searchInput" placeholder=" " autocomplete="off"/>
      <label>Поиск препарата</label>
      <button id="clearSearchBtn" class="clear-btn">×</button>
    </div>
    <div id="suggestions"></div>

    <div id="selectedItems"></div>

    <button id="newBaseBtn">Новая база</button>
    <button id="doneBtn">Готово</button>
    <button class="secondary-btn" id="backFromSearchBtn">Назад</button>
  </div>

  <!-- Список уже собранных баз -->
  <div id="previousBasesContainer" class="hidden section">
    <h3>Уже собранные базы:</h3>
    <div id="previousBasesList"></div>
  </div>
</div>

<script>
/* ----------------------------------------------------------------
   UTILS MODULE: нормализация, alias‑раскатка, сбор canonicalMap,
   сбор компонентов и поиск коктейля
------------------------------------------------------------------*/
const Utils = (() => {
  const rawAliases = {
    "ликферр": "феринжект",
    "берлитион": "альфа-липоевая кислота",
    "софарма": "комплекс витаминов группы в",
    "l-лизина": "l-лизина эсцинат",
    "элькарнитин": "л-карнитин",
    "l-carnitin": "л-карнитин",
    "элькар": "л-карнитин",
    "инозин": "рибоксин",
    "витамин в12": "цианокобаламин",
    "витамин б12": "цианокобаламин",
    "витамин b12": "цианокобаламин",
    "витамин б 12": "цианокобаламин",
    "витамин b 12": "цианокобаламин"
  };

  const rawAdditional = {
    "глутатион":           { price: 7000, dose: 600, unit: "мг" },
    "мексидол":            { price: 2000, dose: 250, unit: "мг" },
    "актовегин":           { price: 2500, dose: 200, unit: "мг" },
    "милдронат":           { price: 2000, dose: 500, unit: "мг" },
    "цераксон":            { price: 2000, dose: 1000, unit: "мг" },
    "димефосфон":          { price: 4000, dose: 2, unit: "г" },
    "лимфомиозот":         { price: 2500, dose: 1.1, unit: "мл" },
    "цианокобаламин":      { price: 2000, dose: 0.5, unit: "мг" },
    "лейковорин":          { price: 5000, dose: 50, unit: "мг" },
    "магния сульфат":      { price: 2000, dose: 750, unit: "мг" },
    "кальция глюконат":    { price: 2000, dose: 1000, unit: "мг" },
    "циклоферон":          { price: 2000, dose: 250, unit: "мг" },
    "церебролізин":        { price: 2500, dose: 10, unit: "мг" },
    "полиоксидоний":       { price: 2500, dose: 6, unit: "мг" },
    "пикамилон":           { price: 2000, dose: 200, unit: "мг" },
    "пирацетам":           { price: 1000, dose: 1000, unit: "мг" },
    "рибоксин":            { price: 2000, dose: 200, unit: "мг" },
    "натрия тиосульфат":   { price: 2000, dose: 3000, unit: "мг" },
    "панангин":            { price: 2500, dose: 10, unit: "мг" },
    "l-лизина эсцинат":    { price: 4000, dose: 5, unit: "мг" },
    "глутоксим":           { price: 4000, dose: 30, unit: "мг" },
    "л-карнитин":          { price: 3000, dose: 500, unit: "мг" },
    "коэнзим":             { price: 4000, dose: 2.2, unit: "мл" },
    "гептрал":             { price: 4000, dose: 400, unit: "мг" },
    "цитофлавин":          { price: 4000, dose: 10, unit: "мг" },
    "ремаксол":            { price: 4000, dose: 400, unit: "мл" },
    "реамберин":           { price: 4000, dose: 250, unit: "мл" },
    "альфа-липоевая кислота": { price: 4000, dose: 600, unit: "мг" },
    "езафосфина":          { price: 7000, dose: 500, unit: "мг" },
    "неотон":              { price: 10000, dose: 1000, unit: "мг" },
    "церетон":             { price: 2000, dose: 1000, unit: "мг" },
    "кавинтон":            { price: 2000, dose: 25, unit: "мг" },
    "феринжект":           { price: 6000, dose: 100, unit: "мг" },
    "ликферр":             { price: 6000, dose: 100, unit: "мг" },
    "комплекс витаминов группы в": { price: 4000, dose: 1, unit: "амп" },
    "пиридоксин":          { price: 2000, dose: 2, unit: "мг" },
    "тиамин":              { price: 2000, dose: 2, unit: "мг" },
    "кокарбоксилаза":      { price: 2000, dose: 2, unit: "мг" },
    "флуимуцил":           { price: 3000, dose: 600, unit: "мг" },
    "фосфоглив":           { price: 5000, dose: 500, unit: "мг" },
    "альбумин":            { price: 11000, dose: 100, unit: "мл" },
    "аминовен инфант":     { price: 8000, dose: 100, unit: "мл" },
    "аминовен":            { price: 10000, dose: 500, unit: "мл" },
    "аддамель н":          { price: 3000, dose: 1, unit: "амп" },
    "виталипид н":         { price: 3000, dose: 1, unit: "амп" },
    "смофлипид":           { price: 10000, dose: 100, unit: "мл" },
    "стерофундин":         { price: 4000, dose: 500, unit: "мл" },
    "фриостерин":          { price: 4000, dose: 500, unit: "мл" },
    "эссенциале н":        { price: 5000, dose: 250, unit: "мг" },
    "витамин с":           { price: 2000, dose: 1000, unit: "мг" },
    "витамин д":           { price: 6000, dose: 300000, unit: "ЕД" },
    "тамерит":             { price: 4500, dose: 100, unit: "мг" },
    "венофер":             { price: 6000, dose: 100, unit: "мг" },
    "моликсан":            { price: 2000, dose: 30, unit: "мг" },
    "тиоцетан":            { price: 2000, dose: 1, unit: "амп" }
  };

  const COCKTAILS = [
    {
      name: "Миланский коктейль день 1",
      price: 18000,
      components: {
        "комплекс витаминов группы в": 1,
        "цитофлавин": 1,
        "езафосфина": 1,
        "глутатион": 1,
        "цианокобаламин": 1,
        "витамин с": 2
      }
    },
    {
      name: "Миланский коктейль день 2",
      price: 18000,
      components: {
        "езафосфина": 1,
        "глутатион": 1,
        "цитофлавин": 10,
        "лейковорин": 1
      }
    },
    {
      name: "Спорт",
      price: 12000,
      components: {
        "цитофлавин": 1,
        "коэнзим": 1,
        "актовегин": 10,
        "витамин с": 1000,
        "л-карнитин": 2
      }
    },
    {
      name: "Антистресс",
      price: 10000,
      components: {
        "комплекс витаминов группы в": 1,
        "магния сульфат": 3,
        "пиридоксин": 2,
        "кокарбоксилаза": 2,
        "глутоксим": 1,
        "витамин с": 1000,
        "цианокобаламин": 1
      }
    },
    {
      name: "Детокс+",
      price: 12000,
      components: {
        "реамберин": 1,
        "гептрал": 1,
        "глутатион": 1
      }
    },
    {
      name: "Antiage",
      price: 14000,
      components: {
        "глутатион": 1,
        "витамин с": 500
      }
    },
    {
      name: "Баланс железа",
      price: 6500,
      components: {
        "феринжект": 1
      }
    },
    {
      name: "Баланс железа +",
      price: 8000,
      components: {
        "феринжект": 1,
        "мексидол": 5,
        "витамин с": 500
      }
    },
    {
      name: "Красивая кожа",
      price: 14000,
      components: {
        "эссенциале н": 2,
        "глутатион": 1,
        "витамин с": 1000
      }
    },
    {
      name: "Смарт",
      price: 10000,
      components: {
        "цитофлавин": 1,
        "коэнзим": 1,
        "цераксон": 1,
        "кавинтон": 1,
        "актовегин": 5
      }
    },
    {
      name: "Красота+",
      price: 12000,
      components: {
        "тиоктацид": 1,
        "глутатион": 1,
        "витамин с": 500
      }
    },
    {
      name: "Протеиновый бустер",
      price: 8000,
      components: {
        "аминовен": 1,
        "аддамель н": 0.5
      }
    },
    {
      name: "Усталость прочь",
      price: 12000,
      components: {
        "альфа-липоевая кислота": 1,
        "комплекс витаминов группы в": 1,
        "цитофлавин": 1,
        "милдронат": 10,
        "мексидол": 5
      }
    },
    {
      name: "Орви help",
      price: 10000,
      components: {
        "реамберин": 1,
        "комплекс витаминов группы в": 1,
        "витамин с": 3000,
        "полиоксидоний": 1,
        "кальция глюконат": 1
      }
    },
    {
      name: "Здоровый сон",
      price: 9000,
      components: {
        "гептрал": 1,
        "пикамилон": 1,
        "магния сульфат": 4
      }
    },
    {
      name: "Жиросжигание",
      price: 14000,
      components: {
        "тиоктацид": 1,
        "цитофлавин": 10,
        "коэнзим": 1,
        "л-карнитин": 1,
        "витамин с": 1000
      }
    },
    {
      name: "Здоровые сосуды",
      price: 10000,
      components: {
        "l-лизина эсцинат": 1,
        "мексидол": 10,
        "актовегин": 10,
        "витамин с": 500
      }
    },
    {
      name: "Здоровые волосы",
      price: 15000,
      components: {
        "l-лизина эсцинат": 2,
        "аминовен": 1,
        "аддамель н": 0.5,
        "комплекс витаминов группы в": 1,
        "лейковорин": 50
      }
    },
    {
      name: "Антигистаминная",
      price: 10000,
      components: {
        "l-лизина эсцинат": 2,
        "магния сульфат": 3,
        "пиридоксин": 2,
        "натрия тиосульфат": 10,
        "кальция глюконат": 1
      }
    },
    {
      name: "Противовирусная",
      price: 12000,
      components: {
        "реамберин": 1,
        "l-лизина эсцинат": 2,
        "циклоферон": 1,
        "кальция глюконат": 1,
        "витамин с": 1000
      }
    },
    {
      name: "Пост ковид",
      price: 10000,
      components: {
        "димефосфон": 2,
        "реамберин": 1,
        "комплекс витаминов группы в": 1,
        "л-карнитин": 2,
        "цераксон": 1
      }
    },
    {
      name: "Омега",
      price: 12000,
      components: {
        "смофлипид": 1,
        "виталипид н": 2,
        "комплекс витаминов группы в": 1
      }
    },
    {
      name: "Brain activity",
      price: 10000,
      components: {
        "цитофлавин": 1,
        "пирацетам": 3,
        "мексидол": 10,
        "актовегин": 5
      }
    },
    {
      name: "Иммунитет",
      price: 17000,
      components: {
        "реамберин": 1,
        "комплекс витаминов группы в": 1,
        "тамерит": 2,
        "витамин с": 3000,
        "цераксон": 1,
        "кальция глюконат": 10
      }
    },
    {
      name: "Коллагеностимуляция",
      price: 24000,
      components: {
        "цитофлавин": 1,
        "коэнзим": 1,
        "эссенциале н": 2,
        "аминовен": 1,
        "аддамель н": 0.5,
        "л-карнитин": 1,
        "витамин с": 1000,
        "глутатион": 600
      }
    },
    {
      name: "Jetlag",
      price: 16000,
      components: {
        "цитофлавин": 10,
        "коэнзим": 1,
        "комплекс витаминов группы в": 1,
        "магния сульфат": 3,
        "пиридоксин": 2,
        "кокарбоксилаза": 2,
        "l-лизина эсцинат": 10,
        "л-карнитин": 1,
        "витамин с": 1000,
        "цианокобаламин": 1
      }
    },
    {
      name: "Противоотечная процедура",
      price: 9000,
      components: {
        "димефосфон": 2,
        "l-лизина эсцинат": 2,
        "лимфомиозот": 1
      }
    }
  ];

  const BASES = [
    { name: "Бустер физ.р-р", price: 0 },
    { name: "Бустер стерил", price: 0 },
    { name: "Глюкоза 5% 200.0", price: 0 },
    { name: "Глюкоза 5% 100 (200-100)", price: 0 },
    { name: "физ р-р 100", price: 0 },
    { name: "физ р-р 200", price: 0 },
    { name: "физ р-р 250", price: 0 },
    { name: "Стерофундин 500", price: 4000 },
    { name: "Фриостерин 500", price: 4000 },
    { name: "Реамбирин 250", price: 4000 },
    { name: "Ремаксол 400", price: 4000 },
    { name: "Аминовен 100 мл", price: 8000 },
    { name: "Аминовен 500 мл", price: 10000 },
    { name: "Смофлипид 100 мл", price: 10000 }
  ];

  const BASE_TO_COMPONENT = {
    "реамбирин 250":   { "реамберин": 250 },
    "ремаксол 400":    { "ремаксол": 400 },
    "стерофундин 500": { "стерофундин": 500 },
    "фриостерин 500":  { "фриостерин": 500 },
    "смофлипид 100 мл": { "смофлипид": 100 },
    "аминовен 100 мл": { "аминовен": 100 },
    "аминовен 500 мл": { "аминовен": 500 }
  };

  function normalize(name) {
    const key = name.toLowerCase().trim();
    return rawAliases[key] || key;
  }

  const canonicalMap = {};
  Object.entries(rawAdditional).forEach(([name, info]) => {
    const norm = normalize(name);
    canonicalMap[norm] = { ...info };
  });
  Object.entries(rawAliases).forEach(([alias, canon]) => {
    const normAlias = alias.toLowerCase().trim();
    const normCanon = normalize(canon);
    if (canonicalMap[normCanon]) canonicalMap[normAlias] = canonicalMap[normCanon];
  });

  function collectComponents(list) {
    const merged = {};
    list.forEach(({ baseComponents, selected }) => {
      Object.entries(baseComponents || {}).forEach(([k, v]) => {
        const nk = normalize(k);
        merged[nk] = (merged[nk] || 0) + v;
      });
      Object.entries(selected || {}).forEach(([k, v]) => {
        const nk = normalize(k);
        merged[nk] = (merged[nk] || 0) + v;
      });
    });
    return merged;
  }

  function findBestCocktail(componentsMap) {
    let best = null, bestExcess = Infinity;
    COCKTAILS.forEach(c => {
      let enough = true, excess = 0;
      Object.entries(c.components).forEach(([k, needed]) => {
        const nk = normalize(k);
        const have = componentsMap[nk] || 0;
        if (have < needed) { enough = false; return; }
        excess += (have - needed);
      });
      if (!enough) return;
      if (excess < bestExcess) {
        bestExcess = excess;
        const leftover = {};
        Object.entries(c.components).forEach(([k, needed]) => {
          const nk = normalize(k);
          const rem = componentsMap[nk] - needed;
          if (rem > 0) leftover[nk] = rem;
        });
        best = { cocktail: c, leftover };
      }
    });
    return best;
  }

  return {
    normalizeIngredient: normalize,
    canonicalMap,
    collectComponents,
    findBestCocktail,
    BASES,
    BASE_TO_COMPONENT,
    COCKTAILS
  };
})();

/* -------------------------------------------------------
   Глобальные переменные
---------------------------------------------------------*/
let allBases = [];           // [{ baseName, basePrice, selectedItems }, ...]
let currentBaseName = null;
let currentBasePrice = 0;
let selectedItems = {};      // { имя_препарата: доза, ... }
let userFio = "";            // ФИО клиента
let currentStep = 0;         // 0: старт,1: ФИО,2: база,3: препараты

/* -------------------------------------------------------
   DEBOUNCE UTILITY
---------------------------------------------------------*/
function debounce(fn, delay) {
  let timer = null;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

/* -------------------------------------------------------
   Собираем список подсказок: все ключи canonicalMap
---------------------------------------------------------*/
const allNames = Object.keys(Utils.canonicalMap);

/* -------------------------------------------------------
   Смена шага
---------------------------------------------------------*/
const containers = [
  "startContainer",
  "fioContainer",
  "baseContainer",
  "searchContainer"
];
function showStep(stepIndex) {
  containers.forEach((id, i) => {
    document.getElementById(id).style.display = i === stepIndex ? "block" : "none";
  });
  if (currentStep === 3 && stepIndex === 2) {
    selectedItems = {};
    currentBaseName = null;
    currentBasePrice = 0;
  }
  currentStep = stepIndex;
}

/* -------------------------------------------------------
   Обработчик поиска препаратов с debounce и лимитом
---------------------------------------------------------*/
function handleSearchInput() {
  const query = document.getElementById('searchInput').value.toLowerCase().trim();
  const suggestionsDiv = document.getElementById('suggestions');
  const clearBtn = document.getElementById('clearSearchBtn');
  suggestionsDiv.innerHTML = '';
  clearBtn.style.display = query ? 'block' : 'none';
  if (!query) return;
  let matched = allNames.filter(n => n.includes(query)).slice(0, 10);
  matched.forEach(m => {
    const info = Utils.canonicalMap[m];
    const div = document.createElement('div');
    div.className = 'suggestion';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = m;

    const doseInput = document.createElement('input');
    doseInput.type = 'number';
    doseInput.step = '0.01';
    doseInput.value = info.dose;
    doseInput.min = '0';
    doseInput.max = String(info.dose * 10);

    const unitSpan = document.createElement('span');
    unitSpan.className = 'unit';
    unitSpan.textContent = info.unit || '';

    const addBtn = document.createElement('button');
    addBtn.textContent = 'Добавить';
    addBtn.disabled = doseInput.value.trim() === '';

    doseInput.addEventListener('input', () => {
      addBtn.disabled = doseInput.value.trim() === '';
    });

    addBtn.addEventListener('click', () => {
      const val = parseFloat(doseInput.value) || info.dose;
      const norm = Utils.normalizeIngredient(m);
      selectedItems[norm] = (selectedItems[norm] || 0) + val;
      document.getElementById('searchInput').value = '';
      suggestionsDiv.innerHTML = '';
      renderSelectedItems();
    });

    div.appendChild(nameSpan);
    div.appendChild(doseInput);
    div.appendChild(unitSpan);
    div.appendChild(addBtn);
    suggestionsDiv.appendChild(div);
  });
}

/* -------------------------------------------------------
   Кнопка очистки поиска
---------------------------------------------------------*/
function clearSearch() {
  document.getElementById('searchInput').value = '';
  document.getElementById('suggestions').innerHTML = '';
  document.getElementById('clearSearchBtn').style.display = 'none';
}

/* -------------------------------------------------------
   Отрисовка выбранных препаратов
---------------------------------------------------------*/
function renderSelectedItems() {
  const container = document.getElementById('selectedItems');
  container.innerHTML = '<h3>Выбранные препараты:</h3>';
  if (!Object.keys(selectedItems).length) {
    container.innerHTML += '<p>Пусто</p>';
    return;
  }
  const ul = document.createElement('ul');
  Object.entries(selectedItems).forEach(([name, val]) => {
    const li = document.createElement('li');
    li.textContent =
`${name}: ${val} ${Utils.canonicalMap[name]?.unit || ''} — 
${Math.round((Utils.canonicalMap[name]?.price || 0) * (val / (Utils.canonicalMap[name]?.dose || 1)))} руб.`;

    const editBtn = document.createElement('button');
    editBtn.textContent = 'Изм.';
    editBtn.onclick = () => {
      const newVal = prompt('Введите новую дозировку:', val);
      if (newVal !== null && !isNaN(parseFloat(newVal))) {
        selectedItems[name] = parseFloat(newVal);
        renderSelectedItems();
      }
    };

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'X';
    removeBtn.onclick = () => {
      delete selectedItems[name];
      renderSelectedItems();
    };

    const wrapper = document.createElement('span');
    wrapper.appendChild(editBtn);
    wrapper.appendChild(removeBtn);
    li.appendChild(wrapper);
    ul.appendChild(li);
  });
  container.appendChild(ul);

  const local = findCocktailPartialMatch(selectedItems, currentBaseName);
  if (local) {
    const note = document.createElement('div');
    note.className = 'note';
    note.textContent = `Состав этой базы включает коктейль "${local.cocktail.name}" (цена: ${local.cocktail.price} руб.)`;
    container.appendChild(note);
  }
}

/* -------------------------------------------------------
   Поиск локального коктейля одной базы
---------------------------------------------------------*/
function findCocktailPartialMatch(selected, baseName) {
  if (!baseName) return null;
  const baseComp = Utils.BASE_TO_COMPONENT[baseName.toLowerCase()] || {};
  const merged = Utils.collectComponents([{ baseComponents: baseComp, selected }]);
  return Utils.findBestCocktail(merged);
}

/* -------------------------------------------------------
   Поиск глобального коктейля всех баз
---------------------------------------------------------*/
function findSingleGlobalCocktail() {
  const list = allBases.map(b => ({
    baseComponents: Utils.BASE_TO_COMPONENT[b.baseName.toLowerCase()] || {},
    selected: b.selectedItems
  }));
  const merged = Utils.collectComponents(list);
  return Utils.findBestCocktail(merged);
}

/* -------------------------------------------------------
   Формирование прописи
---------------------------------------------------------*/
function buildPropis() {
  const lines = [];
  allBases.forEach((b, i) => {
    lines.push(`База #${i+1}: ${b.baseName}`);
    const keys = Object.keys(b.selectedItems);
    if (!keys.length) {
      lines.push('   (без доп. препаратов)');
    } else {
      keys.forEach(k => {
        lines.push(`   "${capitalize(k)}" доза ${b.selectedItems[k]}`);
      });
    }
  });
  return lines.join('\n');
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

/* -------------------------------------------------------
   Сохранение базы
---------------------------------------------------------*/
function saveCurrentBase() {
  if (currentBaseName) {
    allBases.push({
      baseName: currentBaseName,
      basePrice: currentBasePrice,
      selectedItems: { ...selectedItems }
    });
  }
  currentBaseName = null;
  currentBasePrice = 0;
  selectedItems = {};
}

/* -------------------------------------------------------
   Отрисовка ранее собранных баз
---------------------------------------------------------*/
function renderPreviousBases() {
  const c = document.getElementById('previousBasesList');
  c.innerHTML = '';
  allBases.forEach((b, i) => {
    const d = document.createElement('div');
    d.className = 'base-record';
    d.innerHTML = `<strong>База #${i+1}: ${b.baseName}</strong>`;
    if (!Object.keys(b.selectedItems).length) {
      d.innerHTML += '<p>Без доп. препаратов</p>';
    } else {
      const ul = document.createElement('ul');
      Object.entries(b.selectedItems).forEach(([n,v]) => {
        const li = document.createElement('li');
        li.textContent = `${n}: ${v}`;
        ul.appendChild(li);
      });
      d.appendChild(ul);
    }
    c.appendChild(d);
  });
  document.getElementById('previousBasesContainer').style.display =
    allBases.length ? 'block' : 'none';
}

/* -------------------------------------------------------
   Расчет цены и формирование объяснения
---------------------------------------------------------*/
function calculateTotalAndExplanation() {
  const global = findSingleGlobalCocktail();
  let grandTotal = 0, details = '';
  if (global) {
    const { cocktail, leftover } = global;
    grandTotal += cocktail.price;
    const paidBases = [];
    allBases.forEach(b => {
      if (b.basePrice>0 && !baseIsInCocktail(cocktail, b.baseName)) {
        grandTotal += b.basePrice;
        paidBases.push(`+ База "${b.baseName}" (${b.basePrice} руб.)`);
      }
    });
    let leftoverCost = 0, leftoverLines = [];
    Object.entries(leftover).forEach(([n,qty]) => {
      const info = Utils.canonicalMap[n];
      const factor = Math.max(qty / (info.dose||1), 1);
      const cost = Math.round(info.price * factor);
      leftoverCost += cost;
      leftoverLines.push(`+ Доп. ${capitalize(n)} ${qty}${info.unit} (${cost} руб.)`);
    });
    grandTotal += leftoverCost;
    details = `Коктейль "${cocktail.name}" (${cocktail.price} руб.)\n`
            + (paidBases.length? paidBases.join('\n') + '\n' : '')
            + (leftoverLines.length? leftoverLines.join('\n') + '\n' : '')
            + `Итого без скидки: ${grandTotal} руб.`;
  } else {
    const lines = [];
    allBases.forEach((b,i) => {
      let sum = 0, line = `База #${i+1}: ${b.baseName}`;
      const local = findCocktailPartialMatch(b.selectedItems, b.baseName);
      if (local) {
        const cObj = local.cocktail;
        sum += cObj.price;
        line += `\n   Коктейль "${cObj.name}" (${cObj.price} руб.)`;
        if (b.basePrice>0 && !baseIsInCocktail(cObj, b.baseName)) {
          sum += b.basePrice;
          line += `\n   + Платная база (${b.basePrice} руб.)`;
        }
        Object.entries(local.leftover).forEach(([n,qty]) => {
          const info = Utils.canonicalMap[n];
          const factor = Math.max(qty / (info.dose||1), 1);
          const cost = Math.round(info.price * factor);
          sum += cost;
          line += `\n   + ${capitalize(n)} ${qty}${info.unit} (${cost} руб.)`;
        });
      } else {
        if (b.basePrice>0) {
          sum += b.basePrice;
          line += `\n   Платная база (${b.basePrice} руб.)`;
        }
        Object.entries(b.selectedItems).forEach(([n,qty]) => {
          const info = Utils.canonicalMap[n];
          const factor = Math.max(qty / (info.dose||1), 1);
          const cost = Math.round((info?info.price:0) * factor);
          sum += cost;
          line += `\n   "${capitalize(n)}" ${qty}${info.unit} (${cost} руб.)`;
        });
      }
      line += `\n   Итого по базе #${i+1}: ${sum} руб.`;
      lines.push(line);
      grandTotal += sum;
    });
    details = `Детали расчета:\n${lines.join('\n\n')}\nИтого без скидки: ${grandTotal} руб.`;
  }

  let discount = 0;
  if (grandTotal > 30000) discount = 0.10;
  else if (grandTotal > 25000) discount = 0.07;
  else if (grandTotal > 20000) discount = 0.05;
  let discountMsg = '';
  if (discount) {
    const dAmt = Math.round(grandTotal * discount);
    const finalTotal = Math.round(grandTotal * (1-discount));
    discountMsg = `\nПрименена скидка ${Math.round(discount*100)}% (${dAmt} руб.), итог: ${finalTotal} руб.`;
    grandTotal = finalTotal;
  }

  const propis = buildPropis();
  const explanation = `Ваш расчет:\n\nФИО: ${userFio}\nИтоговая цена: ${grandTotal} руб.\n\n`
                    + details
                    + discountMsg
                    + `\n\nПропись:\n${propis}`;
  return { total: grandTotal, explanation };
}

function baseIsInCocktail(cocktail, baseName) {
  const comp = Utils.BASE_TO_COMPONENT[baseName.toLowerCase()] || {};
  return Object.entries(comp).every(([k,v]) => cocktail.components[k] === v);
}

/* -------------------------------------------------------
   Обработчики UI
---------------------------------------------------------*/
function onStart() { showStep(1); }
function onSaveFio() {
  const val = document.getElementById('fioInput').value.trim();
  if (!val) return alert('Введите ФИО клиента!');
  userFio = val;
  showStep(2);
}
function onSelectBase(name, price) {
  saveCurrentBase();
  currentBaseName = name;
  currentBasePrice = price;
  selectedItems = {};
  document.getElementById('currentBaseIndicator').textContent = 'Текущая база: ' + name;
  showStep(3);
  renderSelectedItems();
}
function onNewBase() {
  saveCurrentBase();
  renderPreviousBases();
  showStep(2);
}
function onDone() {
  saveCurrentBase();
  renderPreviousBases();
  const { total, explanation } = calculateTotalAndExplanation();
  Telegram.WebApp.sendData(JSON.stringify({
    user_id: userId,
    user_fio: userFio,
    bases: allBases,
    total_price: total,
    explanation
  }));
}
function goBack() { if (currentStep>0) showStep(currentStep-1); }

/* -------------------------------------------------------
   Инициализация
---------------------------------------------------------*/
let userId = null;
{
  const params = new URLSearchParams(window.location.search);
  userId = params.get('user_id');
}
window.Telegram.WebApp.expand();

window.onload = () => {
  document.getElementById('startBtn').addEventListener('click', onStart);
  document.getElementById('saveFioBtn').addEventListener('click', onSaveFio);
  document.getElementById('searchInput')
    .addEventListener('input', debounce(handleSearchInput, 200));
  document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);
  document.getElementById('newBaseBtn').addEventListener('click', onNewBase);
  document.getElementById('doneBtn').addEventListener('click', onDone);
  document.getElementById('backFromFioBtn').addEventListener('click', () => showStep(0));
  document.getElementById('backFromBaseBtn').addEventListener('click', () => showStep(1));
  document.getElementById('backFromSearchBtn').addEventListener('click', () => showStep(2));

  const baseButtonsDiv = document.getElementById('baseButtons');
  Utils.BASES.forEach(b => {
    const btn = document.createElement('button');
    btn.textContent = b.name;
    btn.onclick = () => onSelectBase(b.name, b.price);
    baseButtonsDiv.appendChild(btn);
  });
};
</script>
</body>
</html>
